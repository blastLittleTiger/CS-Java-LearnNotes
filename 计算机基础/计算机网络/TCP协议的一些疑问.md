### TCP协议的一些疑问

***

#### TCP的状态

在TCP层，有个FLAGS字段，这个字段有以下几个标识：**SYN**, **FIN**, **ACK**, **PSH**, **RST**, **URG**

| 字段 | 含义 |
|--------|--------|
|SYN|表示建立连接，Synchronous，是TCP/IP建立连接时使用的**握手信号**|
|FIN|表示关闭连接，Finish，是**结束信号**，表示将要关闭连接) |
|ACK|表示响应，Acknowledgement，是**确认信号**，表示发来的数据已确认接收无误|
|PSH|表示有 DATA数据传输|
|RST|表示连接重置|



#### 三次握手，四次挥手
1.TCP三次握手
TCP协议是如何保证可靠性的呢？就是**通过三次与目标设备的通信来确定数据包发送成功**。以浏览器和服务器的通信来打比方：

>浏览器：你好服务器，我是 浏览器A。
服务器：你好 浏览器A，我是 服务器B。
浏览器：服务器B 你好。

- **三次握手描述**
>![TCP三次握手](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_n16.png)
>
>第一次握手：建立连接时，客户端发送syn包（syn=j）到服务器，并进入SYN_SENT状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。
第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；
第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。

**图片中的Seq(Sequence number(顺序号码))随机产生，用来表明顺序**

2.TCP四次挥手
当数据包发送完毕需要**断开连接**的时候，就需要TCP的四次挥手来保证链接的合理断开。再次以浏览器和服务器的通信打比方：
>主动结束方：你好，我的数据发送完毕了，我要**进入准备断开的状态**了。（++此时它虽然不再发送数据了，但是可以接受数据++）
>另一方：我知道了，我还没有发送完毕的，你等着吧。
>另一方：我也发送完毕了，可以断开链接了。（此时它也进入准备断开的状态）
>主动结束方：好的，那断开吧。

- **四次挥手描述**
>- **官方描述**
![TCP四次挥手](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_sicihuishou.jpg)
>
>1.客户端A发送一个FIN，用来关闭客户A到服务器B的数据传送。
2.服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。
3.服务器B关闭与客户端A的连接，发送一个FIN给客户端A。
4.客户端A发回ACK报文确认，并将确认序号设置为收到序号加1。
>
>- **简易描述**
![TCP四次挥手](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_n17.png)

3.TCP为什么建立链接是三次，关闭链接是四次？
**连接时**：因为服务端的listen状态下的socket当收到SYN报文的建连请求后，它**可以把ACK和SYN（ACK起应答作用，而SYN起同步作用）放在一个报文里来发送**。
**关闭时**，**当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了**；++但未必你所有的数据都全部发送给对方了++，所以你可能未必会马上会关闭SOCKET，也即你可能还需要发送一些数据给对方之后，*再发送FIN报文给对方来表示你同意现在可以关闭连接了*，**所以它这里的ACK报文和FIN报文多数情况下都是分开发送的**。



#### 两台电脑之间的通信
1.有两台电脑A和B，A电脑想向B电脑发送一条信息，那该怎么办呢？

其实很简单，就像邮递员（假设为电脑A）要给某栋大楼内的某个房间的客户（假设为电脑B）送邮件一样，邮递员要想把邮件送到客户手上，那他必须知道客户的**大楼名称**（或者说地址，**作用是定位**）以及客户在这栋大楼内的**房间号**（**作用是传送数据**）。在互联网的世界中也是一样，电脑A想向电脑B发送一条信息，电脑A就得知道电脑B的MAC地址和IP地址。

*补充：MAC地址*

>以太网规定，连入网络的所有设备，都必须具有“**网卡**”接口。**数据包必须是从一块网卡，传送到另一块网卡**。++网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址++。
就是说要想上网就得有块叫做“网卡”的东西，电脑的网卡很好理解，大家经常接触；而像路由器，交换机，手机，平板等联网的设备都有“网卡”。**两台设备之间的通信就相当于两块网卡之间的通信**，而这个网卡就是MAC地址，MAC地址就相当于“送邮件”例子中的客户房间号。
每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，**MAC地址长度是48个二进制位，通常用12个十六进制数表示**。前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。
![MAC地址图片](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_macaddr.png)
**IP地址就相当于“送邮件”例子中的大楼名称（或者说地址）**。


2.IP与Mac的作用
**IP**：**设备的定位**
**MAC**：**数据发送**
![通信1](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_%e9%80%9a%e4%bf%a11.jpg)
![通信2](http://images.cnblogs.com/cnblogs_com/prayjourney/1041349/o_%e9%80%9a%e4%bf%a12.jpg)
3.总结
A电脑想向B电脑发送一条信息，首先A电脑要知道B电脑的MAC地址和IP地址，这其中IP地址一般是已知的，而MAC地址是未知的。++这时候就需要通过**ARP协议**来确定B电脑的MAC地址++，***IP--->MAC***:ARP(地址解析协议)，***MAC--->IP***:RARP(反向地址解析协议)）。只要拿到了电脑B的IP地址和MAC地址，两台电脑就可以通信了。
**两台电脑之间的通信，归根结底为两个网卡之间数据包的发送，数据包发送必须要知道MAC地址（网卡地址），而IP地址是对于电脑设备的定位，不知道两台设备的IP，两个设备之间就无法连接，所以说IP只是相当于对于设备的定位，而真正的数据发送是由网卡MAC来完成的，说IP传输数据，其实是默认IP包含了Mac的功能**

ref:
1.[网络请求过程扫盲](http://www.jianshu.com/p/8a40f99da882), 2.[TCP的状态 (SYN, FIN, ACK, PSH, RST, URG)](http://www.cnblogs.com/azraelly/archive/2012/12/25/2832393.html), 3.[TCP的几个状态 (SYN, FIN, ACK, PSH, RST, URG)](http://www.yunsec.net/a/school/wlcs/agreement/2012/0317/10262.html), 4.[SYN_百度百科](https://baike.baidu.com/item/SYN), 5.[ACK_百度百科](https://baike.baidu.com/item/ACK), 6.[一次完整的浏览器请求流程](http://www.jianshu.com/p/fbe0e9fa45a6)


